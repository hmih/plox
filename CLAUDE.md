# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project

Plox is a Chrome Manifest V3 extension paired with a Python server. The extension scans X.com timelines for `@handle` elements and reports them to the server at `plox.krepost.xy`. The server persists usernames in SQLite and, when location data is available, returns it so the extension can inject a country/region flag emoji next to the handle. A background worker on the server side processes new entries (currently dry-run only — it logs but does not scrape X.com).

## Commands

### Extension

| Action | Command |
|--------|---------|
| Install deps | `npm install` |
| Build extension | `npm run build` (or `make build`) |
| Run all tests | `npm test` (or `make test`) |
| Run a single test | `npx playwright test tests/<file>.spec.ts` |
| Format code | `./scripts/format.sh` (or `make format`) |
| Type-check | `npx tsc --noEmit` |
| Bootstrap environment | `make setup` |
| Package for distribution | `make dist` |

Build uses esbuild (`build.js`) to bundle `src/background.ts` and `src/content.ts` into `extension/` as IIFE targeting Chrome 121+. The server URL is injected at build time via `PLOX_SERVER_URL` env var (default `https://plox.krepost.xy`).

### Server

| Action | Command |
|--------|---------|
| Start containers | `make server-up` |
| Stop containers | `make server-down` |
| Tail logs | `make server-logs` |
| Run server tests | `make server-test` |
| Run server locally | `cd server && python3 app.py` |

Server tests use pytest. Install deps with `pip install flask pytest`.

## Architecture

### Extension (Chrome MV3)

Three source files in `src/`:

- **`core.ts`** — `REGION_FLAGS` map and `getFlagEmoji()` (maps location string to flag emoji via name lookup then ISO country code).

- **`background.ts`** — Service worker. Listens for `"processHandle"` messages, queries `GET /met?username=<handle>` on the plox server, deduplicates concurrent requests via a `pending` Set, caches results in a `Map`, and sends `"visualizeFlag"` back to the content script when the server returns a processed location.

- **`content.ts`** — Content script injected into X.com pages. Uses `MutationObserver` + `requestIdleCallback` to scan DOM for `@handle` elements, assigns `data-plox-id` attributes, sends `"processHandle"` to the background worker, and injects flag badges on `"visualizeFlag"` response.

Message flow: Content script discovers handle → `"processHandle"` → background queries server → if processed, `"visualizeFlag"` → content script prepends flag badge.

### Server (Python/Flask)

Three files in `server/`:

- **`app.py`** — Flask app with `GET /met?username=<handle>` endpoint. Creates a new DB entry if the username is unseen, returns `{username, processed, location}` JSON. Normalizes usernames to lowercase.

- **`db.py`** — SQLite connection helper. Table `data` with columns: `id`, `username` (unique where not soft-deleted), `processed`, `location`, `created_at`, `updated_at`, `deleted_at`. WAL mode for concurrent access.

- **`worker.py`** — Background poller. Checks for unprocessed entries and logs what it would scrape (dry-run). Does not modify DB rows or make external requests.

### Docker

`docker-compose.yaml` defines two services sharing a `plox-data` volume:
- `plox-server` — gunicorn on port 5000
- `plox-worker` — runs `worker.py` with configurable `PLOX_POLL_INTERVAL`

## Key conventions

- TypeScript strict mode with aggressive checks (`noUncheckedIndexedAccess`, `exactOptionalPropertyTypes`, `noPropertyAccessFromIndexSignature`). Avoid `any`.
- Python code formatted with black.
- Prettier for TypeScript/JS formatting (run via `scripts/format.sh`).
- Extension output in `extension/` — only `manifest.json` and `styles.css` are hand-written; `.js` files are generated by the build.
- Tests mock the plox server responses (JSON) in Playwright route handlers. MHTML fixtures still used for realistic DOM content in `tests/plox.spec.ts`.
- Commit messages: lowercase, action-oriented (e.g., "add flag caching", "fix parser fallback").
